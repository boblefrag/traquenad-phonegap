/**
 * @license RequireJS text 2.0.10 Copyright (c) 2010-2012, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/requirejs/text for details
 */

/*!
 * mustache.js - Logic-less {{mustache}} templates with JavaScript
 * http://github.com/janl/mustache.js
 */

/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */

define("text",["module"],function(e){var t,n,r,i,s,o=["Msxml2.XMLHTTP","Microsoft.XMLHTTP","Msxml2.XMLHTTP.4.0"],u=/^\s*<\?xml(\s)+version=[\'\"](\d)*.(\d)*[\'\"](\s)*\?>/im,a=/<body[^>]*>\s*([\s\S]+)\s*<\/body>/im,f=typeof location!="undefined"&&location.href,l=f&&location.protocol&&location.protocol.replace(/\:/,""),c=f&&location.hostname,h=f&&(location.port||undefined),p={},d=e.config&&e.config()||{};t={version:"2.0.10",strip:function(e){if(e){e=e.replace(u,"");var t=e.match(a);t&&(e=t[1])}else e="";return e},jsEscape:function(e){return e.replace(/(['\\])/g,"\\$1").replace(/[\f]/g,"\\f").replace(/[\b]/g,"\\b").replace(/[\n]/g,"\\n").replace(/[\t]/g,"\\t").replace(/[\r]/g,"\\r").replace(/[\u2028]/g,"\\u2028").replace(/[\u2029]/g,"\\u2029")},createXhr:d.createXhr||function(){var e,t,n;if(typeof XMLHttpRequest!="undefined")return new XMLHttpRequest;if(typeof ActiveXObject!="undefined")for(t=0;t<3;t+=1){n=o[t];try{e=new ActiveXObject(n)}catch(r){}if(e){o=[n];break}}return e},parseName:function(e){var t,n,r,i=!1,s=e.indexOf("."),o=e.indexOf("./")===0||e.indexOf("../")===0;return s!==-1&&(!o||s>1)?(t=e.substring(0,s),n=e.substring(s+1,e.length)):t=e,r=n||t,s=r.indexOf("!"),s!==-1&&(i=r.substring(s+1)==="strip",r=r.substring(0,s),n?n=r:t=r),{moduleName:t,ext:n,strip:i}},xdRegExp:/^((\w+)\:)?\/\/([^\/\\]+)/,useXhr:function(e,n,r,i){var s,o,u,a=t.xdRegExp.exec(e);return a?(s=a[2],o=a[3],o=o.split(":"),u=o[1],o=o[0],(!s||s===n)&&(!o||o.toLowerCase()===r.toLowerCase())&&(!u&&!o||u===i)):!0},finishLoad:function(e,n,r,i){r=n?t.strip(r):r,d.isBuild&&(p[e]=r),i(r)},load:function(e,n,r,i){if(i.isBuild&&!i.inlineText){r();return}d.isBuild=i.isBuild;var s=t.parseName(e),o=s.moduleName+(s.ext?"."+s.ext:""),u=n.toUrl(o),a=d.useXhr||t.useXhr;if(u.indexOf("empty:")===0){r();return}!f||a(u,l,c,h)?t.get(u,function(n){t.finishLoad(e,s.strip,n,r)},function(e){r.error&&r.error(e)}):n([o],function(e){t.finishLoad(s.moduleName+"."+s.ext,s.strip,e,r)})},write:function(e,n,r,i){if(p.hasOwnProperty(n)){var s=t.jsEscape(p[n]);r.asModule(e+"!"+n,"define(function () { return '"+s+"';});\n")}},writeFile:function(e,n,r,i,s){var o=t.parseName(n),u=o.ext?"."+o.ext:"",a=o.moduleName+u,f=r.toUrl(o.moduleName+u)+".js";t.load(a,r,function(n){var r=function(e){return i(f,e)};r.asModule=function(e,t){return i.asModule(e,f,t)},t.write(e,a,r,s)},s)}};if(d.env==="node"||!d.env&&typeof process!="undefined"&&process.versions&&!!process.versions.node&&!process.versions["node-webkit"])n=require.nodeRequire("fs"),t.get=function(e,t,r){try{var i=n.readFileSync(e,"utf8");i.indexOf("﻿")===0&&(i=i.substring(1)),t(i)}catch(s){r(s)}};else if(d.env==="xhr"||!d.env&&t.createXhr())t.get=function(e,n,r,i){var s=t.createXhr(),o;s.open("GET",e,!0);if(i)for(o in i)i.hasOwnProperty(o)&&s.setRequestHeader(o.toLowerCase(),i[o]);d.onXhr&&d.onXhr(s,e),s.onreadystatechange=function(t){var i,o;s.readyState===4&&(i=s.status,i>399&&i<600?(o=new Error(e+" HTTP status: "+i),o.xhr=s,r(o)):n(s.responseText),d.onXhrComplete&&d.onXhrComplete(s,e))},s.send(null)};else if(d.env==="rhino"||!d.env&&typeof Packages!="undefined"&&typeof java!="undefined")t.get=function(e,t){var n,r,i="utf-8",s=new java.io.File(e),o=java.lang.System.getProperty("line.separator"),u=new java.io.BufferedReader(new java.io.InputStreamReader(new java.io.FileInputStream(s),i)),a="";try{n=new java.lang.StringBuffer,r=u.readLine(),r&&r.length()&&r.charAt(0)===65279&&(r=r.substring(1)),r!==null&&n.append(r);while((r=u.readLine())!==null)n.append(o),n.append(r);a=String(n.toString())}finally{u.close()}t(a)};else if(d.env==="xpconnect"||!d.env&&typeof Components!="undefined"&&Components.classes&&Components.interfaces)r=Components.classes,i=Components.interfaces,Components.utils["import"]("resource://gre/modules/FileUtils.jsm"),s="@mozilla.org/windows-registry-key;1"in r,t.get=function(e,t){var n,o,u,a={};s&&(e=e.replace(/\//g,"\\")),u=new FileUtils.File(e);try{n=r["@mozilla.org/network/file-input-stream;1"].createInstance(i.nsIFileInputStream),n.init(u,1,0,!1),o=r["@mozilla.org/intl/converter-input-stream;1"].createInstance(i.nsIConverterInputStream),o.init(n,"utf-8",n.available(),i.nsIConverterInputStream.DEFAULT_REPLACEMENT_CHARACTER),o.readString(n.available(),a),o.close(),n.close(),t(a.value)}catch(f){throw new Error((u&&u.path||"")+": "+f)}};return t}),define("text!place_type_list.html",[],function(){return'<div class="topcoat-list">\n  <ul class="topcoat-list__container">\n    {{#placetypes}}\n    <li class="topcoat-list__item placetype" id="{{name}}">\n      <i class="{{icon}}"></i> {{name}}\n    </li>\n    {{/placetypes}}\n  </ul>\n\n</div>\n'}),function(e,t){if(typeof exports=="object"&&exports)t(exports);else{var n={};t(n),typeof define=="function"&&define.amd?define("mustache",n):e.Mustache=n}}(this,function(e){function a(e,t){return u.call(e,t)}function f(e){return!a(r,e)}function h(e){return typeof e=="function"}function p(e){return e.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}function v(e){return String(e).replace(/[&<>"'\/]/g,function(e){return d[e]})}function m(e){if(!c(e)||e.length!==2)throw new Error("Invalid tags: "+e);return[new RegExp(p(e[0])+"\\s*"),new RegExp("\\s*"+p(e[1]))]}function g(r,u){function E(){if(v&&!g)while(d.length)delete h[d.pop()];else d=[];v=!1,g=!1}u=u||e.tags,r=r||"",typeof u=="string"&&(u=u.split(n));var a=m(u),l=new w(r),c=[],h=[],d=[],v=!1,g=!1,S,x,T,N,C,k;while(!l.eos()){S=l.pos,T=l.scanUntil(a[0]);if(T)for(var L=0,A=T.length;L<A;++L)N=T.charAt(L),f(N)?d.push(h.length):g=!0,h.push(["text",N,S,S+1]),S+=1,N==="\n"&&E();if(!l.scan(a[0]))break;v=!0,x=l.scan(o)||"name",l.scan(t),x==="="?(T=l.scanUntil(i),l.scan(i),l.scanUntil(a[1])):x==="{"?(T=l.scanUntil(new RegExp("\\s*"+p("}"+u[1]))),l.scan(s),l.scanUntil(a[1]),x="&"):T=l.scanUntil(a[1]);if(!l.scan(a[1]))throw new Error("Unclosed tag at "+l.pos);C=[x,T,S,l.pos],h.push(C);if(x==="#"||x==="^")c.push(C);else if(x==="/"){k=c.pop();if(!k)throw new Error('Unopened section "'+T+'" at '+S);if(k[1]!==T)throw new Error('Unclosed section "'+k[1]+'" at '+S)}else x==="name"||x==="{"||x==="&"?g=!0:x==="="&&(a=m(u=T.split(n)))}k=c.pop();if(k)throw new Error('Unclosed section "'+k[1]+'" at '+l.pos);return b(y(h))}function y(e){var t=[],n,r;for(var i=0,s=e.length;i<s;++i)n=e[i],n&&(n[0]==="text"&&r&&r[0]==="text"?(r[1]+=n[1],r[3]=n[3]):(t.push(n),r=n));return t}function b(e){var t=[],n=t,r=[],i,s;for(var o=0,u=e.length;o<u;++o){i=e[o];switch(i[0]){case"#":case"^":n.push(i),r.push(i),n=i[4]=[];break;case"/":s=r.pop(),s[5]=i[2],n=r.length>0?r[r.length-1][4]:t;break;default:n.push(i)}}return t}function w(e){this.string=e,this.tail=e,this.pos=0}function E(e,t){this.view=e==null?{}:e,this.cache={".":this.view},this.parent=t}function S(){this.cache={}}var t=/\s*/,n=/\s+/,r=/\S/,i=/\s*=/,s=/\s*\}/,o=/#|\^|\/|>|\{|&|=|!/,u=RegExp.prototype.test,l=Object.prototype.toString,c=Array.isArray||function(e){return l.call(e)==="[object Array]"},d={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"};w.prototype.eos=function(){return this.tail===""},w.prototype.scan=function(e){var t=this.tail.match(e);if(t&&t.index===0){var n=t[0];return this.tail=this.tail.substring(n.length),this.pos+=n.length,n}return""},w.prototype.scanUntil=function(e){var t=this.tail.search(e),n;switch(t){case-1:n=this.tail,this.tail="";break;case 0:n="";break;default:n=this.tail.substring(0,t),this.tail=this.tail.substring(t)}return this.pos+=n.length,n},E.prototype.push=function(e){return new E(e,this)},E.prototype.lookup=function(e){var t;if(e in this.cache)t=this.cache[e];else{var n=this;while(n){if(e.indexOf(".")>0){t=n.view;var r=e.split("."),i=0;while(t!=null&&i<r.length)t=t[r[i++]]}else t=n.view[e];if(t!=null)break;n=n.parent}this.cache[e]=t}return h(t)&&(t=t.call(this.view)),t},S.prototype.clearCache=function(){this.cache={}},S.prototype.parse=function(e,t){var n=this.cache,r=n[e];return r==null&&(r=n[e]=g(e,t)),r},S.prototype.render=function(e,t,n){var r=this.parse(e),i=t instanceof E?t:new E(t);return this.renderTokens(r,i,n,e)},S.prototype.renderTokens=function(t,n,r,i){function u(e){return o.render(e,n,r)}var s="",o=this,a,f;for(var l=0,p=t.length;l<p;++l){a=t[l];switch(a[0]){case"#":f=n.lookup(a[1]);if(!f)continue;if(c(f))for(var d=0,v=f.length;d<v;++d)s+=this.renderTokens(a[4],n.push(f[d]),r,i);else if(typeof f=="object"||typeof f=="string")s+=this.renderTokens(a[4],n.push(f),r,i);else if(h(f)){if(typeof i!="string")throw new Error("Cannot use higher-order sections without the original template");f=f.call(n.view,i.slice(a[3],a[5]),u),f!=null&&(s+=f)}else s+=this.renderTokens(a[4],n,r,i);break;case"^":f=n.lookup(a[1]);if(!f||c(f)&&f.length===0)s+=this.renderTokens(a[4],n,r,i);break;case">":if(!r)continue;f=this.parse(h(r)?r(a[1]):r[a[1]]),f!=null&&(s+=this.renderTokens(f,n,r,i));break;case"&":f=n.lookup(a[1]),f!=null&&(s+=f);break;case"name":f=n.lookup(a[1]),f!=null&&(s+=e.escape(f));break;case"text":s+=a[1]}}return s},e.name="mustache.js",e.version="0.8.0",e.tags=["{{","}}"];var x=new S;e.clearCache=function(){return x.clearCache()},e.parse=function(e,t){return x.parse(e,t)},e.render=function(e,t,n){return x.render(e,t,n)},e.to_html=function(t,n,r,i){var s=e.render(t,n,r);if(!h(i))return s;i(s)},e.escape=v,e.Scanner=w,e.Context=E,e.Writer=S}),define("text!place_list.html",[],function(){return'<div class="topcoat-list">\n<ul class="topcoat-list__container">\n{{#places}}\n<li class="topcoat-list__item place" id="{{place.address}}">\n<h4>\n  {{place.name}} {{distance}} \n  <i class="glyphicon glyphicon-thumbs-up"></i>\n{{place.likes}}\n  <i class="glyphicon glyphicon-thumbs-down"></i>\n{{place.dislikes}}\n\n</h4>\n<p>{{place.place_type.name}}</p>\n<p>{{place.address}}</p>\n<p>{{place.description}}</p>\n</li>\n\n{{/places}}\n</ul>\n</div>\n'}),define("text!geolocation.html",[],function(){return'<p>Position: {{position}}</p>\n<button type="button" class="btn btn-primary" id="change">Modifier</button>\n'}),define("text!geo_change.html",[],function(){return'<form role="geo_change" id="geochange-form">\n  <input type="text" name="address"\n         placeholder="Enter your address"\n         class="form-control"\n         required />\n  <button type="submit" class="btn btn-lg btn-primary btn-block"\n         id="change-geo">\n    Valider\n  </button>\n</form>\n'}),define("text!geo_choices.html",[],function(){return'<form role="geo_choice" id="geochoice-form">\n{{#choices}}\n<label>\n<input type="radio" name="choice" value="{{display_name}}" />\n{{display_name}}\n</label>\n{{/choices}}\n<button type="submit" class="btn btn-lg btn-primary btn-block">\n</form>\n'}),define("text!place_details.html",[],function(){return'<button type="button" class="btn btn-default" id="retour">Retour</button>\n\n<div>\n  <h4>{{place.name}}\n    <i class="glyphicon glyphicon-thumbs-up"></i>\n    {{place.likes}}\n    <i class="glyphicon glyphicon-thumbs-down"></i>\n    {{place.dislikes}}\n  </h4>\n  <p>{{place.place_type.name}}</p>\n  <p>{{place.address}}</p>\n  <p>{{place.description}}</p>\n\n  <div class="topcoat-list">\n    <ul class="topcoat-list__container">\n      {{#place.near}}\n      <li class="topcoat-list__item place" id="{{address}}">\n        <h4>\n          {{name}}\n          <i class="glyphicon glyphicon-thumbs-up"></i>\n          {{likes}}\n          <i class="glyphicon glyphicon-thumbs-down"></i>\n          {{dislikes}}\n\n        </h4>\n        <p>{{place_type.name}}</p>\n        <p>{{address}} {{#toFixed}}{{geoadress.distance}}{{/toFixed}} mètres</p>\n        <p>{{description}}</p>\n      </li>\n      {{/place.near}}\n    </ul>\n  </div>\n'});var datamapper={places:[],placetypes:[],lat:null,lon:null,initialize:function(e){this.places=e},get_places:function(){return this.places},get_placetypes:function(){return this.placetypes},get_placetypes_templates:function(){require(["text!place_type_list.html","mustache"],function(e,t){var n=e,r={placetypes:datamapper.placetypes.placetypes};console.log(r),output=t.render(e,r),document.getElementById("wrapper").innerHTML=output})},get_places_templates:function(){require(["text!place_list.html","mustache"],function(e,t){var n=e,r={places:datamapper.places.places};output=t.render(e,r),document.getElementById("wrapper").innerHTML=output,places=document.querySelectorAll(".place");for(var i=0;i<places.length;i++)places[i].addEventListener("click",datamapper.get_details,!1)})},placetype:function(){this.placetypes=data},setgeo:function(e){datamapper.lat=e.coords.latitude,datamapper.lon=e.coords.longitude,console.log(datamapper.lat,datamapper.lon),require(["text!geolocation.html","mustache"],function(e,t){api.getNominatim(datamapper.lat,datamapper.lon,e,t)})},ongeoError:function(e){require(["text!geolocation.html","mustache"],function(t,n){var r={position:"Erreur: Impossible de vous localiser "+e.message+" "+e.code},i=t;output=n.render(t,r),document.getElementById("geolocation").innerHTML=output,document.getElementById("change").addEventListener("click",datamapper.locForm,!1)})},locForm:function(){require(["text!geo_change.html","mustache"],function(e,t){var n={},r=e;output=t.render(e,n),document.getElementById("geolocation").innerHTML=output,document.getElementById("geochange-form").addEventListener("submit",datamapper.locValidate,!1)})},locValidate:function(e){e.preventDefault(),api.getNominatimReverse(this.elements.address.value)},geo_choices:function(e){require(["text!geo_choices.html","mustache"],function(t,n){var r={choices:e};output=n.render(t,r),document.getElementById("geolocation").innerHTML=output,document.getElementById("geochoice-form").addEventListener("click",function(){var e=this.elements.choice;for(var t=0;t<r.choices.length;t++)for(var n=0;n<e.length;n++)if(e[n].checked){var i=e[n];break}for(var t=0;t<r.choices.length;t++)if(r.choices[t].display_name==i.value){datamapper.lat=r.choices[t].lat,datamapper.lon=r.choices[t].lon,require(["text!geolocation.html","mustache"],function(e,t){api.getNominatim(datamapper.lat,datamapper.lon,e,t)});break}},!1)})},get_details:function(e){for(var t=0;t<datamapper.places.places.length;t++)if(datamapper.places.places[t].place.address==this.id){var n={place:datamapper.places.places[t].place,toFixed:function(){return function(e,t){return parseFloat(t(e)).toFixed(0)}}};require(["text!place_details.html","mustache"],function(e,t){var r=e;output=t.render(e,n),document.getElementById("wrapper").innerHTML=output,document.getElementById("retour").addEventListener("click",datamapper.get_places_templates,!1),places=document.querySelectorAll(".place");for(var i=0;i<places.length;i++)places[i].addEventListener("click",datamapper.get_details,!1)})}}};define("datamapper",function(){});var db=function(){this.token="None",this.initialize=function(){this.dbShell=window.openDatabase("traquenard","0.1","traquenard",1e3),this.dbShell.transaction(function(e){e.executeSql("CREATE TABLE IF NOT EXISTS token (id unique, token)")})},this.save_token=function(e){this.dbShell.transaction(function(t){str='INSERT INTO token (id, token) VALUES (1, "'+e+'")',t.executeSql(str)},function(e,t){console.log(t)},function(e){database.get_token()})},this.set_token=function(e){this.token=e,app.onGetToken(e)},this.get_token=function(e){this.dbShell.transaction(function(t){t.executeSql("SELECT * FROM token",[],function(t,n){console.log(n),n.rows.length==0?database.set_token(!1,e):database.set_token(n.rows.item(0).token,e)})})}};define("datastore",function(){}),define("text!login.html",[],function(){return'<div class="container">\n\n<form role="login" id="login-form" class="form-signin">\n  <h2 class="form-signin-heading">Log in</h2>\n{{#error}}\n<div class="alert alert-danger">\n  <a class="close" data-dismiss="alert">×</a>  \n    {{error}}\n</div>\n{{/error}}\n\n    <input type="text" class="form-control" id="login"\n           placeholder="Enter username"\n           required autofocus>\n\n    <input type="password" class="form-control" id="password"\n           placeholder="Password"\n           required>\n  <button type="submit" class="btn btn-lg btn-primary btn-block">Valider</button>\n</form>\n</div>\n'});var api={url:"http://www.traquenard.net/",check_login:function(e){e.preventDefault(),params="password="+this.elements.password.value+"&username="+this.elements.login.value,console.log(params);var t=new XMLHttpRequest;t.open("POST",api.url+"/get_token/",!0),t.setRequestHeader("Content-type","application/x-www-form-urlencoded"),t.onload=function(){this.status!=200?require(["text!login.html","mustache"],function(e,t){var n={error:"Wrong username or password"},r=e;output=t.render(e,n),document.getElementById("wrapper").innerHTML=output,document.getElementById("login-form").addEventListener("submit",api.check_login,!1)}):(token=JSON.parse(this.responseText).token,database.save_token(token),api.getMyplace())},t.send(params)},getMyplace:function(e,t){var n=new XMLHttpRequest;string="lat="+encodeURIComponent(e)+"&lon="+encodeURIComponent(t),n.open("GET",api.url+"/api/geoadress/?"+string,!0),n.setRequestHeader("Authorization","Token "+database.token),n.onload=function(){this.status==200&&(data={places:JSON.parse(this.responseText)},datamapper.initialize(data),datamapper.get_places_templates())},n.send()},getPlaceType:function(){var e=new XMLHttpRequest;e.open("GET",api.url+"/api/placetype/",!0),e.setRequestHeader("Authorization","Token "+database.token),e.onload=function(){this.status==200&&(data={placetypes:JSON.parse(this.responseText)},datamapper.placetype(data),datamapper.get_placetypes_templates())},e.send()},getNominatim:function(e,t,n,r){var i=new XMLHttpRequest;i.open("GET","http://nominatim.openstreetmap.org/reverse?format=json&lat="+e+"&lon="+t,!0),i.onload=function(){var e={position:JSON.parse(this.responseText).display_name},t=n;output=r.render(n,e),document.getElementById("geolocation").innerHTML=output,document.getElementById("change").addEventListener("click",datamapper.locForm,!1)},i.send()},getNominatimReverse:function(e){var t=new XMLHttpRequest;t.open("GET","http://nominatim.openstreetmap.org/?format=json&countrycodes=fr&q="+encodeURIComponent(e),!0),t.onload=function(){datamapper.geo_choices(JSON.parse(this.responseText))},t.send()}};define("api",function(){}),require.config({baseUrl:"./tpl/",paths:{index:"../index",datamapper:"../datamapper",datastore:"../datastore",api:"../api",mustache:"../mustache"},shim:{mustache:{exports:"Mustache"}}}),require(["datamapper","datastore","api"],function(e,t,n){var e=e,t=t,n=n});var app={initialize:function(){document.addEventListener("deviceready",this.onDeviceReady,!1)},onDeviceReady:function(){console.log("ready"),datamapper.initialize(),database=new db,database.initialize(),database.get_token(app)},onGetToken:function(e){e==0?require(["text!login.html","mustache"],function(e,t){var n={},r=e;output=t.render(e,n),document.getElementById("wrapper").innerHTML=output,document.getElementById("login-form").addEventListener("submit",api.check_login,!1)}):(api.getPlaceType(),require(["text!geolocation.html","mustache"],function(e,t){var n={position:"chargement"},r=e;output=t.render(e,n),document.getElementById("geolocation").innerHTML=output}),navigator.geolocation.getCurrentPosition(datamapper.setgeo,datamapper.ongeoError,{maximumAge:3e3,timeout:5e4,enableHighAccuracy:!0}))}};define("index",function(){});